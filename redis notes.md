# Redis缓存雪崩和穿透怎么处理？


# Redis布隆过滤器
## 用途
- 去重。用来判断一个元素是否在一个集合中。
## 过程
1. 用一个位数组arr去记录数据存在/不存在。一个长度为10000的位数组只占用10000/8=1250B空间。
2. 此时请求发送一个字符串A，用f1,f2,f3这三个哈希函数对A计算，得到n1,n2,n3。
3. 在位数组中把arr[n1],arr[n2],arr[n3]置为1。
4. 请求再发送字符串A，用f1,f2,f3计算出n1,n2,n3，发现arr中三个值都是1，那么说明A存在。

## 注意点
- 随着数据量增大，可能有多个数据计算出来的结果是一样的，就可能导致布隆过滤器误判。
- 布隆过滤器可能误判“存在”,但是如果过滤器中不存在，那就一定是不存在。

## 实际应用
- 

# Redis集群
- Redis主从架构 -> 读写分离 -> 支持10w+读QPS
## 主从架构，master节点必须持久化
- 如果master节点被关掉而没有持久化，那么在master节点挂掉重启后，数据是空的，然后经过复制，所有slave节点上的数据也空了。
  
### Redis replica基本原理
- master节点采用异步方式复制数据到slave。slave节点会周期性地向master确认自己的复制量。
- 一个master节点可以配置多个slave节点，一个slave节点也可以和其他slave节点通信。
- slave节点复制的时候不阻塞master节点的工作
- slave节点复制的时候不影响自己的查询，它会用旧的数据提供查询服务，等所有数据复制完成后，删除旧数据，复制数据集，此时会暂停对外服务（毫秒到秒）。
- slave节点主要用来做水平扩容，做读写分离。
- master fail后，slave节点可以自动接管master。
- 如果sentinel没有及时检测到master fail，那么master重启后，还是可能导致slave数据被master同步清空。

## sentinel 哨兵机制
### 主要作用
- 集群监控，监控master和slave是否正常工作。
- 故障转移，选举slave节点成master。

### 哨兵集群的相互发现
- 通过Redis的pub/sub

### 哨兵必须部署2个以上节点（即至少3个）
#### 为什么？

## Redis集群如何保证高可用？
- 一个master和多个slave节点组成的redis集群如何保证高可用，任何一个slave节点挂掉不会影响redis，但是如果master挂掉，那么所以写操作就会失效，slave节点也没用了，此时就会出现不可用的情况。
- 主备切换，故障转移。master挂掉后，其中一个slave节点会升级成master，保证缓存服务正常。切换过程中可能有几秒钟甚至几分钟不可用。

## 集群脑裂如何减少损失？
- 由于网络原因master节点被隔离，sentinel选举了一个slave节点成master，此时集群中出现两个master，出现脑裂，而客户端依然在往原来的master上写数据，master无法异步复制到slave，这部分数据就会丢失。
- 设置min-slaves-max-lags=10，表示master异步复制时间超过10s，就会拒绝写请求，此时一般会在client做降级和限流，把写到本地磁盘里，同时减少请求涌入，以此减少丢失的数据。或者client可以临时把消息放入消息队列，每隔一段时间取一次，尝试重新发给master。


# Redis过期策略？
## 定期删除和动态删除。

# Redis怎么保证高并发和高可用？

# Redis主从原理？

# Redis哨兵机制？

# Redis持久化
## RDB
- 每隔一段时间记录一次Redis在内存中所有数据的快照，适合做冷备。
  - Redis在做RDB备份时会fork一个子进程来执行，如果数据文件特别大，可能导致服务暂停数毫秒，甚至数秒。
- 做数据恢复时，直接把RDB文件中的数据拷贝到内存中即可。
  - 优点
    - 直接保存数据，原理简单，恢复简单。
    - 恢复数据方便。
  - 缺点
    - 丢数据会比较多，不适合做第一优先的恢复方案。

## AOF
- 每次Redis操作会把操作记录到AOF文件中。
  - 其实每次Redis的操作会先被记录到os cache中，然后Redis会(每隔一秒或几秒)调用一次fsync写入到磁盘。
- AOF文件会不断增大，当到达一定大小时，Redis会对AOF进行rewrite，即根据当前Redis中的内存数据生成新的AOF文件，然后在这个新的AOF文件里记录操作指令，同时删除旧AOF文件。
  - 优点
    - 丢数据比较少，最多丢一杪（或者几秒）。
    - 以append-only模式写入，没有任何磁盘寻址的开销，写入性能非常高，文件不容易破损，即使尾部破损，也很容易修复。
    - 如果把Redis设置成每写入一条数据就fsync一次，可以保证一条数据都不丢，但是这样会严重影响Redis的QPS。
  - 缺点
    - 占用磁盘空间较多。
    - 每次都写磁盘，性能比RDB差一点。
    - 做数据恢复的时候会比较慢，不方便做定期的冷备。

# Redis数据类型有哪些?
## String 字符串(sds.h)

- 可以直接获取字符串长度O(1)。
- 相比C字符串，SDS实现了空间预分配和空间惰性释放。SDS会给字符串预留一定的分配空间，避免每次字符串增长时都去请求新的内存空间。SDS会记录总空间长度，已使用字符串长度和未使用字符串长度，避免字符串在增长或者缩短时频繁计算。

- 二进制安全。有了字符串长度作为有效数据的指标，避免有些特殊数据格式（比如图片，音频等二进制数据）会因为'\0'字符导致后面的字符串无效。即可以保存文本也可以保存二进制数据。

## List 链表
### 用法
- lrange 可以做查询的分页，比如评论，粉丝列表。

## Hash 字典(dict.h)


## Set 集合
### 无序集合，自动去重。对数据做交集，并集，差集。

## ZSet 跳表
### 可以按照分数字段给数据排序。比如排行榜。





