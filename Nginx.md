# 负载均衡
## 加权轮训算法
- 每个节点有三个权重变量，分别是：
1. weight：在配置文件中设置的每个节点的约定权重。
2. effectiveWeight：有效权重。如果节点异常，则把权重-1，如果请求成功则+1，直到恢复到weight。
3. currentWeight：节点当前权重，初始化为0。
- 算法逻辑
1. 轮询所有节点，计算当前状态下所有节点的effectiveWeight和totalWeight，总权重totalWeight即所有节点的有效权重。
2. 一个请求到来时，选出所有节点中currentWeight最大的进行处理，然后把重新计算节点权重 currentWeigth = currrentWeight - totalWeight。

- 举例
    - 假设三个节点a，b，c，权重分别为4，2，1。
    - totalWeight = 4 + 2 + 1 = 7。
    - 计算7次请求被分配在三个节点的情况。

| 请求序列 | currentWeight | 选中节点 | currrentWeight - totalWeight |
| -- | -- | -- | -- |
| 1 | {4, 2 ,1} |  a | {-3, 2, 1} |
| 2 | {1, 4, 2} |  b | {1, -3, 2} |
| 3 | {5, -1, 3} | a | {-2, -1, 3} |
| 4 | {2, 1, 4} | c | {2, 1, -3} |
| 5 | {6, 3, -2} | a | {-1, 3, -2} |
| 6 | {3, 5, -1} | b | {3, -2, -1} |
| 7 | {7, 0, 0} | a | {0, 0, 0} |

> 相比直接在队列里放入 {a,a,a,a,b,b,c}，以上算法能保证请求分派的均衡性。避免请求在同一时刻被密集地打到同一台服务器上。